---
title: "Manikin data"
author: "Tina Lasisi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  workflowr::wflow_html:
    toc: yes
    toc_float: true
    number_sections: yes
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

library(tidyverse)
library(knitr)
library(kableExtra)
library(fs)
library(janitor)
library(fuzzyjoin)
library(tidyquant)
library(ggstatsplot)


F = rprojroot::is_rstudio_project$make_fix_file()

palettedf <- tibble(paletteer::palettes_d_names)

# filter(.data = palettedf, length > 10 & type == "qualitative")

knitr::opts_chunk$set(echo = FALSE, include = TRUE, eval = TRUE, warning = FALSE, message = FALSE, fig.retina = 2, fig.width = 8, fig.height = 6, out.width = "100%")

```


```{r df_import, include=FALSE}

# Importing data

Havenith_2020_tidy <- read_csv(F("data/tidy/Havenith_2020_tidy.csv"), 
    col_types = cols(
      wig = col_factor(levels = c("Nude", 
        "LowCurv", "MidCurv", "HighCurv")), 
      radiation = col_factor(levels = c("off", 
            "on")),
      wind = col_factor(levels = c("0.3", "1", "2.5")), 
      tsk = col_factor(levels = c("34.0", "38.0")),
      wet_dry = col_factor(levels = c("dry", 
            "wet"))))

head(Havenith_2020_tidy)

```


```{r df_summary, include=FALSE}

# means and sd

sum_manikin_df <- Havenith_2020_tidy %>% 
  group_by(wig, radiation, wind, wet_dry, tsk) %>% 
  summarise(across(
    where(is.numeric), 
    list(mean = mean, s = sd), 
    na.rm = TRUE, 
    .names = "{col}_{fn}"
    ),
    n = n()
    )

head(sum_manikin_df)

```


```{r df_solinflux, include=FALSE}

# solar influx

dry_influx_df <- sum_manikin_df %>% 
  select(wig, radiation, wind, wet_dry, tsk, w_m2_mean) %>% 
  filter(wet_dry == "dry") %>% 
  pivot_wider(names_from = radiation, values_from = w_m2_mean) %>% 
  mutate(net_w_m2 = off-on)

corr4c_dry_influx_df <- sum_manikin_df %>% 
  select(wig, radiation, wind, wet_dry, tsk, w_m2_mean, m2k_W_mean) %>% 
  mutate(
    w_m2_4C = 
      case_when(radiation == "off" ~ 28/m2k_W_mean,
                TRUE ~ NaN),
    w_m2_30C = 
      case_when(radiation == "off" ~ 5/m2k_W_mean,
                TRUE ~ NaN)) %>% 
  drop_na() %>% 
  ungroup() %>% 
  select(-radiation)

dry_influx_df2 <- inner_join(dry_influx_df, corr4c_dry_influx_df) %>% 
  mutate(solar_w_m2_4C = w_m2_4C-net_w_m2,
         solar_w_m2_30C = w_m2_30C-net_w_m2,
         sweat_zero_gain = case_when(
           solar_w_m2_30C < 0 ~ abs(solar_w_m2_30C/2430*3600),
           TRUE ~ 0
         )) %>% 
  select(wig, wind, wet_dry, tsk, w_m2_4C, w_m2_30C, solar_w_m2_4C, solar_w_m2_30C, sweat_zero_gain)



wet_influx_df <- sum_manikin_df %>% 
  select(wig, radiation, wind, wet_dry, tsk, w_m2_mean) %>% 
  filter(wet_dry == "wet") %>%
  pivot_wider(names_from = radiation, values_from = w_m2_mean) %>% 
  mutate(net_w_m2 = off-on) %>% 
  drop_na() 

dry_merge <- dry_influx_df2 %>% 
  ungroup() %>% 
  select(-wet_dry, -tsk)

wet_influx_df2 <- full_join(dry_merge, wet_influx_df) %>% 
  mutate(dry_wet_30C = w_m2_30C + on,
         diff_dry_wet = dry_wet_30C-solar_w_m2_30C,
         sweat_max = diff_dry_wet/2430*3600) %>% 
  select(wig, wind, wet_dry, w_m2_4C, w_m2_30C, dry_wet_30C, diff_dry_wet, sweat_max)

```


# Heat loss (raw)

The dry measurements were taken at two different temperatures - one with $T_{manikin}= 34^\circ C$ and $T_{ambient}= 8^\circ C$, and another with $T_{manikin}= 38^\circ C$ and $T_{ambient}= 4^\circ C$.

The second set of temperature options was found to be necessary with the straight (low curvature) wig in the $0.3\; m/s$ wind speed setting with the radiation on because the manikin would overheat to the point where no heat loss could be measured. We then made sure to conduct all the $0.3\; m/s$ wind speed experiments with this second option. 

In the preparation of the data, we applied a correction to bring all the measurements to the same temperature, i.e. $T_{ambient}= 4^\circ C$. 

The wet measurements are based on heat exchange rather than dry heat loss. These measurements were taken with the temperature settings $T_{manikin}= 34^\circ C$ and $T_{ambient}= 34^\circ C$ or $T_{manikin}=T_{ambient}$. The measurements have been converted to heat loss for comparative purposes.

```{r plt_drywet_scatter}

merge1 <- bind_rows(wet_influx_df, dry_influx_df)

plot <- ggplot(merge1, aes(off, on)) +
  geom_point(aes(shape = wind, fill=wig), size = 5) +
  scale_shape_manual(values = c(21,22,23, 24))+
  theme_bw() +
  geom_abline(slope = 1, intercept = 0)+
  xlim(0, 500) +
  ylim(0, 500) +
  ggtitle("Dry heat loss and wet heat exchange data")+
  theme(plot.title = element_text(hjust = 0.5), plot.caption = element_text(hjust = 0.5))+
  labs(caption = "Comparison of dry heat loss and wet heat exchange for various head coverings\n at 3 wind speeds with radiation on/off", x = bquote('Radiation off'~(W/m^2)), y = bquote('Radiation on'~(W/m^2)))+
  guides(fill=guide_legend(override.aes = list(shape=21))) +
  coord_fixed() +
  facet_wrap(vars(wet_dry)) +
  theme(legend.position = "bottom", legend.box = "vertical", legend.margin = margin())

print(plot)


```


# Solar influx 

We can also look specifically at the effect of the radiation by subtracting the measurements with radiation off from those with radiation on. 

From the plots below, it is apparent that the experiments with a "Nude" manikin scalp show a considerably different pattern than any of the wigs. 

Interestingly, in the dry experiments, the effect of solar radiation appears to cluster more by wig, while the wet experiments show a solar influx that is more patterned by wind speed.

## As function of heat loss (radiation off)

```{r plt_drywet_scatter2}


plot <- ggplot(merge1, aes(off, net_w_m2)) +
  geom_point(aes(shape = wind, fill=wig), size = 5) +
  scale_shape_manual(values = c(21,22,23, 24))+
  theme_bw() +
  geom_hline(yintercept =  0) +
  ggtitle("Solar influx")+
  theme(plot.title = element_text(hjust = 0.5), plot.caption = element_text(hjust = 0.5))+
  labs(caption = "This plot shows the solar influx as a function of heat loss in the radiation off state. \nThe horizontal line is at zero showing that all values are positive.", x = bquote('Radiation off'~(W/m^2)), y = bquote('Solar influx'~(W/m^2)))+
  guides(fill=guide_legend(override.aes = list(shape=21))) +
  theme(legend.position = "bottom", legend.box = "vertical", legend.margin = margin()) +
  facet_wrap(vars(wet_dry)) 

print(plot)


```

## As function of wind speed

Below, we plot the same net heat loss as a function of wind speed. Similarly, we see that, in the dry experiments, there is a very clear effect of wig type and no hair, while the wet experiments show a much more pronounced effect of windspeed.

```{r plt_influx}


plot <- ggplot(merge1, aes(wind, net_w_m2)) +
  geom_point(aes(color=wig, fill=wig), size = 3) +
  ylim(0, 200) +
  geom_path(aes(group=wig, color=wig))+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(title = "Solar influx as function of wind", x = bquote('Wind speed'~(m/s)), y=bquote('Solar influx'~(W/m^2))) +
facet_wrap(vars(wet_dry)) +
theme(legend.position = "bottom", legend.box = "vertical", legend.margin = margin())

print(plot)

```

## Heat loss unstandardized lm
```{r lm_rawheatloss}
raw.heatloss.lm <- lm(
  formula = 
    w_m2_mean ~ wet_dry + radiation + as.numeric(wind) + wig + wet_dry*as.numeric(wind) + wet_dry*wig + wet_dry*radiation + radiation*wig,
  data = sum_manikin_df)
```


```{r tbl_lm_rawheatloss}
lmdf <- summary(raw.heatloss.lm) %>% 
  broom::tidy()

lmdf %>% 
  kbl %>% 
  kable_minimal()
```


```{r plt_lm_rawheatloss}
ggstatsplot::ggcoefstats(
  x = raw.heatloss.lm,
  sort = "ascending",
  ggtheme = ggplot2::theme_bw(),
  package = "Polychrome",
  palette = "dark",
  only.significant = T
)

```

## Heat loss standardized lm
```{r lm_rawheatloss_std}
raw.heatloss.lm.beta <-  lm(
  formula = 
    scale(w_m2_mean) ~ wet_dry + radiation + scale(as.numeric(wind)) + wig + wet_dry*scale(as.numeric(wind)) + wet_dry*wig + wet_dry*radiation + radiation*wig,
  data = sum_manikin_df)
```


```{r tbl_lm_rawheatloss_std}
lmdf <- summary(raw.heatloss.lm.beta) %>% 
  broom::tidy()

lmdf %>% 
  kbl %>% 
  kable_minimal()
```


```{r plt_lm_rawheatloss_std}
ggstatsplot::ggcoefstats(
  x = raw.heatloss.lm.beta,
  sort = "ascending",
  ggtheme = ggplot2::theme_bw(),
  package = "Polychrome",
  palette = "dark",
  only.significant = T
)

```


# Heat loss at 30 C

Here are plots for the total heat losses (convective + radiative) recalculated for an ambient temperature of $30^\circ C$. 

What becomes apparent now is that there is a substantial heat gain in the dry condition. 

However, the wet condition assumes an "unlimited" amount of sweat (i.e. the most that can be evaporated) - but this is not physiologically realistic. 

```{r df_heat_30C}
combo1 <- dry_influx_df2 %>% 
  select(wig, wind, wet_dry, heat_loss30=solar_w_m2_30C)

combo2 <- wet_influx_df2 %>% 
  select(wig, wind, wet_dry, heat_loss30=dry_wet_30C)

heat_merge_df <- bind_rows(combo1, combo2)
  
df <- heat_merge_df
```


```{r plt_heat_30C, fig.width=12}
plot <- ggplot(df, aes(wind, heat_loss30)) +
  geom_point(aes(color=wig, fill=wig), size = 3) +
  geom_path(aes(group=wig, color=wig))+
  theme_bw() +
  labs(title = "Total heat losses with solar exposure \nrecalculated for ambient temperature of 30C", x = bquote('Wind speed'~(m/s)), y = bquote('Heat loss'~(W/m^2)))+
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(vars(wet_dry)) +
  ylim(-200, 400)

print(plot)


```


We created a linear model to test the significance of various factors on heat loss

## Unstandardized lm
```{r lm_drywet30}
heatloss.lm <- lm(
  formula = 
    heat_loss30 ~ wet_dry + as.numeric(wind) + wig + wet_dry*as.numeric(wind) + wet_dry*wig, 
  data = heat_merge_df)
```


```{r tbl_lm_drywet30}
summary(heatloss.lm) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_drywet30}
ggstatsplot::ggcoefstats(
  x = heatloss.lm,
  sort = "ascending", # sorting the terms of the model based on estimate values
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F,
  only.significant = T
)

```


```{r lm_dry30sep}
df <- heat_merge_df %>% 
  filter(wet_dry == "dry")

heatloss.lm.dry <- lm(
  formula = 
    heat_loss30 ~ as.numeric(wind) + wig, 
  data = df)
```


```{r tbl_lm_dry30sep}
summary(heatloss.lm.dry) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r lm_wet30sep}
df <- heat_merge_df %>% 
  filter(wet_dry == "wet")

heatloss.lm.wet <- lm(
  formula = 
    heat_loss30 ~ as.numeric(wind) + wig, 
  data = df)
```


```{r tbl_lm_wet30sep}
summary(heatloss.lm.wet) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_drywet30sep}
ggstatsplot::combine_plots(
  ggstatsplot::ggcoefstats(
  x = heatloss.lm.dry,
  title = "Dry",
  sort = "ascending", # sorting the terms of the model based on estimate values
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F,
  only.significant = T
),
ggstatsplot::ggcoefstats(
  x = heatloss.lm.wet,
  title = "Wet",
  sort = "ascending", # sorting the terms of the model based on estimate values
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F,
  only.significant = T
)
)


```


## Standardized lm
The differences between wind speed across groups appear to be statistically significant, with the "nude" condition always as an outlier.

```{r lm_drywet30std}
heatloss.lm.beta <- lm(
  formula = 
    scale(heat_loss30) ~ wet_dry + scale(as.numeric(wind)) + wig + wet_dry*scale(as.numeric(wind)) + wet_dry*wig, 
  data = heat_merge_df)
```


```{r tbl_lm_drywet30std}
summary(heatloss.lm.beta) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_drywet30std}
ggstatsplot::ggcoefstats(
  x = heatloss.lm.beta,
  sort = "ascending", # sorting the terms of the model based on estimate values
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F,
  only.significant = T
)

```


```{r lm_dry30sepstd}
df <- heat_merge_df %>% 
  filter(wet_dry == "dry")

heatloss.lm.dry.beta <- lm(
  formula = 
    scale(heat_loss30) ~ scale(as.numeric(wind)) + wig, 
  data = df)
```


```{r tbl_lm_dry30sepstd}
summary(heatloss.lm.dry.beta)%>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r lm_wet30sepstd}
df <- heat_merge_df %>% 
  filter(wet_dry == "wet")

heatloss.lm.wet.beta <- lm(
  formula = 
    scale(heat_loss30) ~ scale(as.numeric(wind)) + wig, 
  data = df)
```


```{r tbl_lm_wet30sepstd}
summary(heatloss.lm.wet.beta)%>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_drywet30sepstd}
ggstatsplot::combine_plots(
  ggstatsplot::ggcoefstats(
  x = heatloss.lm.dry.beta,
  title = "Dry",
  sort = "ascending", 
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F
),
ggstatsplot::ggcoefstats(
  x = heatloss.lm.wet.beta,
  title = "Wet",
  sort = "ascending",
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F
)
)

```


## Effect of evaporative heat loss

Looking at the difference between dry and wet heat loss, we see that the difference is stark between hair and no hair. Suggesting that unlimited evaporation renders hairlessness much more beneficial. We also see a steady increase in the difference between wet and dry heat losses with increases in wind speed due to the increasing contribution of convection to the evaporation.

### Unstandardized

```{r plt_diff_wetdry}

plot <- ggplot(wet_influx_df2, aes(wind, diff_dry_wet)) +
  geom_point(aes(color=wig, fill=wig), size = 3) +
  geom_path(aes(group=wig, color=wig))+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

print(plot)


```

```{r lm_diffwetdry}
diff.wetdry.lm <- lm(
  formula = 
    diff_dry_wet ~ as.numeric(wind) + wig,
  data = wet_influx_df2)
```


```{r tbl_lm_diffwetdry}
lmdf <- summary(diff.wetdry.lm) %>% 
  broom::tidy()

lmdf %>% 
  kbl %>% 
  kable_minimal()
```


```{r plt_lm_diffwetdry}
ggstatsplot::ggcoefstats(
  x = diff.wetdry.lm,
  sort = "ascending",
  ggtheme = ggplot2::theme_bw(),
  package = "Polychrome",
  palette = "dark",
  only.significant = T
)

```


### Standardized
```{r lm_diffwetdry_std}
diff.wetdry.lm.beta <- lm(
  formula = 
    scale(diff_dry_wet )~ scale(as.numeric(wind)) + wig,
  data = wet_influx_df2)
```


```{r tbl_lm_diffwetdry_std}
lmdf <- summary(diff.wetdry.lm.beta) %>% 
  broom::tidy()

lmdf %>% 
  kbl %>% 
  kable_minimal()
```


```{r plt_lm_diffwetdry_std}
ggstatsplot::ggcoefstats(
  x = diff.wetdry.lm.beta,
  sort = "ascending",
  ggtheme = ggplot2::theme_bw(),
  package = "Polychrome",
  palette = "dark",
  only.significant = T
)

```

# Sweat requirement

Another way to approach the comparison is to calculte the sweat rate. Here, we plot the sweat rate potential (left) and the sweat rate required to cancel out heat gain at $T_{ambient} = 30^\circ C$.

What emerges is that while heat loss potential is higher without hair as a barrier (i.e. the "nude" condition), the *potential* sweat far exceeds the physiologically possible sweat rate for humans. The plot for zero heat gain shoes that a nude scalp requires the most sweat and this requirement is inversely correlated with hair curvature.

```{r df_sweat}
combo1 <- wet_influx_df2 %>% 
  select(wig, wind, wet_dry, sweat=sweat_max)

combo2 <- dry_influx_df2 %>% 
  select(wig, wind, wet_dry, sweat=sweat_zero_gain)

sweat_merge_df <- bind_rows(combo1, combo2) %>% 
  rename(sweat_type=wet_dry) %>% 
  mutate(sweat_type = as_factor(
    case_when(sweat_type=="wet" ~ "max",
              sweat_type=="dry" ~ "zero_gain")))
```


```{r plt_sweat, fig.width=12}
plot <- ggplot(sweat_merge_df, aes(wind, sweat)) +
  geom_point(aes(color=wig, fill=wig), size = 3) +
  geom_path(aes(group=wig, color=wig))+
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))+
  facet_wrap(vars(sweat_type))

print(plot)
```

## Unstandardized lm
```{r lm_sweat}
sweat.lm <- lm(
  formula = 
    sweat ~ sweat_type + as.numeric(wind) + wig + sweat_type*as.numeric(wind) + sweat_type*wig, 
  data = sweat_merge_df)
```


```{r tbl_lm_sweat}
summary(sweat.lm) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_sweat}
ggstatsplot::ggcoefstats(
  x = sweat.lm,
  sort = "ascending", # sorting the terms of the model based on estimate values
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F,
  only.significant = T
)

```


```{r lm_maxsep}
df <- sweat_merge_df %>% 
  filter(sweat_type == "max")

sweat.lm.max <- lm(
  formula = 
    sweat ~ as.numeric(wind) + wig, 
  data = df)
```


```{r tbl_lm_maxep}
summary(sweat.lm.max) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r lm_zerogainsep}
df <- sweat_merge_df %>% 
  filter(sweat_type == "zero_gain") %>% 
  droplevels()

sweat.lm.zero_gain <- lm(
  formula = 
    sweat ~ as.numeric(wind) + wig, 
  data = df)
```


```{r tbl_lm_zerogainsep}
summary(sweat.lm.zero_gain) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_sweatsep}
ggstatsplot::combine_plots(
  ggstatsplot::ggcoefstats(
    x = sweat.lm.max,
    title = "max",
    sort = "ascending", # sorting the terms of the model based on estimate values
    ggtheme = ggplot2::theme_bw(),
    package = "ggsci",
    palette = "default_aaas",
    messages = F,
    only.significant = T
  ),
  ggstatsplot::ggcoefstats(
    x = sweat.lm.zero_gain,
    title = "zero_gain",
    sort = "ascending", # sorting the terms of the model based on estimate values
    ggtheme = ggplot2::theme_bw(),
    package = "ggsci",
    palette = "default_aaas",
    messages = F,
    only.significant = T
  )
)


```


## Standardized lm
The differences between wind speed across groups appear to be statistically significant, with the "nude" condition always as an outlier.

```{r lm_sweatstd}
sweat.lm.beta <- lm(
  formula = 
    scale(sweat) ~ sweat_type + scale(as.numeric(wind)) + wig + sweat_type*scale(as.numeric(wind)) + sweat_type*wig, 
  data = sweat_merge_df)
```


```{r tbl_lm_sweatstd}
summary(sweat.lm.beta) %>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_sweatstd}
ggstatsplot::ggcoefstats(
  x = sweat.lm.beta,
  sort = "ascending", # sorting the terms of the model based on estimate values
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F,
  only.significant = T
)

```


```{r lm_maxsepstd}

df <- sweat_merge_df %>% 
  filter(sweat_type == "max")

sweat.lm.max.beta <- lm(
  formula = 
    scale(sweat) ~ scale(as.numeric(wind)) + wig, 
  data = df)

```


```{r tbl_lm_maxsepstd}
summary(sweat.lm.max.beta)%>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```

```{r lm_zerogain_sepstd}
df <- sweat_merge_df %>% 
  filter(sweat_type == "zero_gain") %>% 
  droplevels()

sweat.lm.zero_gain.beta <- lm(
  formula = 
    scale(sweat) ~ scale(as.numeric(wind)) + wig, 
  data = df)
```


```{r tbl_lm_zerogain_sepstd}
summary(sweat.lm.zero_gain.beta)%>% 
  broom::tidy() %>% 
  kbl() %>% 
  kable_minimal()
```


```{r plt_lm_sweatsepstd}
ggstatsplot::combine_plots(
  ggstatsplot::ggcoefstats(
    x = sweat.lm.max.beta,
    title = "max",
    sort = "ascending",
    ggtheme = ggplot2::theme_bw(),
    package = "ggsci",
    palette = "default_aaas",
    messages = F
  ),
  ggstatsplot::ggcoefstats(
  x = sweat.lm.zero_gain.beta,
  title = "zero_gain",
  sort = "ascending", 
  ggtheme = ggplot2::theme_bw(),
  package = "ggsci",
  palette = "default_aaas",
  messages = F
  )
)

```


